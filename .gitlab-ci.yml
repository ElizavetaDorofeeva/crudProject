stages:
  - build
  - test
  - deploy
  - notify

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  APP_NAME: "WebApplication1"
  DEPLOY_PATH: "/opt/$APP_NAME"
  PUBLISH_OUTPUT: "publish"

default:
  image: mcr.microsoft.com/dotnet/sdk:8.0
  tags:
    - private  

cache:
  key: "$CI_COMMIT_REF_SLUG-dotnet"
  paths:
    - .nuget/

before_script:
  - dotnet nuget locals all --list
  - export DOTNET_CLI_HOME="$CI_PROJECT_DIR/.nuget"
  
build:
  stage: build
  script:
    - dotnet restore
    - dotnet build --no-restore
    - dotnet publish -c Release -o $PUBLISH_OUTPUT --self-contained -r linux-x64
  artifacts:
    paths:
      - $PUBLISH_OUTPUT/
    expire_in: 1 week
    
test:
  stage: test
  script:
    - dotnet test --no-build --verbosity normal
  rules:
    - if: '$CI_COMMIT_BRANCH == "test"'  
    
deploy:
  stage: deploy
  script:
    - echo "Deploying to local machine via runner..."
    - mkdir -p $DEPLOY_PATH-backup && cp -r $DEPLOY_PATH/* $DEPLOY_PATH-backup/ || true
    - mkdir -p $DEPLOY_PATH
    - cp -r $PUBLISH_OUTPUT/* $DEPLOY_PATH/
    - cd $DEPLOY_PATH && nohup ./WebApplication1 > app.log 2>&1 &
    - sleep 5
    - curl -s http://localhost:8080/swagger/v1/swagger.json | grep -q "openapi" && echo "✅ App is running" || (echo "❌ App failed to start" && exit 1)
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'  
    
rollback:
  stage: deploy
  script:
    - echo "Rolling back to previous version..."
    - if [ -d "$DEPLOY_PATH-backup" ]; then
        rm -rf $DEPLOY_PATH;
        cp -r $DEPLOY_PATH-backup $DEPLOY_PATH;
        cd $DEPLOY_PATH && nohup ./WebApplication1 > app.log 2>&1 &;
        echo "✅ Rollback completed";
      else
        echo "❌ No backup found";
        exit 1;
      fi
  when: manual  
  
notify-success:
  stage: notify
  image: curlimages/curl
  script:
    - |
      curl -X POST "$TELEGRAM_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d '{
          "text": "*✅ Deployment succeeded!* \n\nVersion: `'${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}'`\nProject: `'${CI_PROJECT_NAME}'`",
          "parse_mode": "Markdown"
        }'
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: on_success

notify-failure:
  stage: notify
  image: curlimages/curl
  script:
    - |
      curl -X POST "$TELEGRAM_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d '{
          "text": "*❌ Deployment failed!* \n\nJob: `'${CI_JOB_NAME}'`\nCommit: `'${CI_COMMIT_SHORT_SHA}'`",
          "parse_mode": "Markdown"
        }'
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: on_failure
      
include:
  - template: Jobs/SAST.gitlab-ci.yml
  
pages:
  stage: deploy
  image: alpine:latest
  script:
    - mkdir -p public
    - "echo '<h1>WebApplication1 CI/CD</h1><p>Swagger: <a href=\"http://localhost:7103/swagger\">OpenAPI</a></p>' > public/index.html"
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'